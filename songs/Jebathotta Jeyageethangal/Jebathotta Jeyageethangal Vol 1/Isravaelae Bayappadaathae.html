<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Isravaelae Bayapadathae</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --note-color:#ff4081;
      --chord-color:#00bcd4;
      --lyric-color:#222;
      --lyric2-color:#555;
      --bg:linear-gradient(135deg,#fbc2eb 0%,#a6c1ee 100%);
      --button-gradient:linear-gradient(135deg,#43cea2,#185a9d);
      --toggle-on:linear-gradient(135deg,#ff8a65,#ff7043);
      --toggle-off:linear-gradient(135deg,#cfd8dc,#90a4ae);
      --fz-note:15px;
      --fz-trans:16px;
      --fz-tamil:15px;
      --fz-chord:15px;
    }

    body.dark {
      --bg:#111;
      --lyric-color:#eee;
      --lyric2-color:#aaa;
      background:#111 !important;
    }

    *{box-sizing:border-box}

    body{
      font-family:'Segoe UI',Roboto,Arial,sans-serif;
      padding:24px;
      margin:0;
      background:var(--bg);
      background-attachment:fixed;
      color:var(--lyric-color);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    @media(max-width:600px){
      :root{
        --fz-note:13px;
        --fz-trans:14px;
        --fz-tamil:13px;
        --fz-chord:13px;
      }
      body{ padding:14px; }
      .controls{ width:100%; padding:14px; }
      button,.toggle-btn{ padding:8px 14px; font-size:14px; }
      .token{ min-width:28px; padding:3px 3px; min-height:68px; }
    }

    .controls{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      margin-bottom:20px;
      background:rgba(255,255,255,0.25);
      backdrop-filter:blur(6px);
      padding:18px;
      border-radius:16px;
      box-shadow:0 4px 14px rgba(0,0,0,0.2);
      width:100%;
      max-width:900px;
    }

    .checkboxes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }

    .toggle-btn{
      padding:10px 16px;
      border:none;
      border-radius:10px;
      background:var(--toggle-off);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:0.3s;
    }
    .toggle-btn.active{
      background:var(--toggle-on);
      transform:scale(1.05);
    }

    .transpose-controls,
    .size-controls{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    button{
      padding:10px 16px;
      border:none;
      border-radius:10px;
      background:var(--button-gradient);
      color:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:15px;
    }

    .value{
      min-width:40px;
      background:#fff;
      border-radius:8px;
      padding:5px 0;
      font-weight:700;
      text-align:center;
      color:#333;
    }

    #savePng{
      background:linear-gradient(135deg,#ff6f91,#ff9671);
    }

    #printBtn{
      background:linear-gradient(135deg,#9b5de5,#b983ff);
    }

    #pdfBtn{
      background:linear-gradient(135deg,#38b2ac,#4fd1c5);
    }

    /* ========== NEW EXPORT BUTTON ROW ========== */
    .export-row{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:nowrap;
      width:100%;
    }

    @media(max-width:600px){
      .export-row{
        flex-wrap:wrap;
      }
    }

    #song{
      width:100%;
      max-width:980px;
      background:rgba(255,255,255,0.7);
      padding:16px;
      border-radius:18px;
      box-shadow:0 4px 20px rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
    }

    body.dark #song {
      background:#222;
    }

    .token{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-height:72px;
      min-width:45px;
      padding:4px 6px;
      background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.3));
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      white-space:nowrap;
    }

    body.dark .token {
      background:#333;
    }

    .chord{
      min-height:18px;
      line-height:18px;
      color:var(--chord-color);
      font-weight:700;
      font-size:var(--fz-chord);
    }

    .song-line{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0;
    }

    .note{color:var(--note-color);font-weight:700;font-size:var(--fz-note);}
    .lyric{font-size:var(--fz-trans);}
    .lyric2{font-size:var(--fz-tamil);color:var(--lyric2-color);font-style:italic;}

    @media print{
      .controls,#printBtn,#savePng,#pdfBtn{display:none!important;}
      body{background:white!important;}
    }
  </style>
</head>
<body>
<div id="globalHeader"></div>

  <div class="controls">
    <button id="darkToggle">üß© Dark Mode</button>

    <div class="checkboxes">
      <button class="toggle-btn active" id="toggleNotesBtn">Notes</button>
      <button class="toggle-btn active" id="toggleTransBtn">Transliteration</button>
      <button class="toggle-btn active" id="toggleTamilBtn">Tamil</button>
      <button class="toggle-btn active" id="toggleChordsBtn">Chords</button>
    </div>

    <div class="transpose-controls">
      <button id="down">‚àí</button>
      <div class="value" id="semitone">0</div>
      <button id="up">+</button>
      <button id="reset">Reset</button>
    </div>

  

    <!-- NEW EXPORT BUTTON ROW -->
    <div class="export-row">
      <button id="savePng">Download as Image</button>
      <button id="printBtn" onclick="window.print()">üñ®Ô∏è Print / PDF</button>
      <button id="pdfBtn">Download PDF</button>
    </div>
  </div>

  <div id="song"></div>

<script>
/* ------------------ DATA ------------------ */
const data = [
      // Line 1
      [
	  {note:'', trans:'Pallavi', tamil:'‡Æ™‡Æ≤‡Øç‡Æ≤‡Æµ‡Æø', chord:''},
	  ],
	  [
	  ],
	  [
        {note:'C', trans:'Is', tamil:'‡Æá‡Æ∏‡Øç', chord:'Cm'},
  {note:'C', trans:'ra', tamil:'‡Æ∞', chord:''},
  {note:'D', trans:'vae', tamil:'‡Æµ‡Øá', chord:'Bb'},
  {note:'D', trans:'lae', tamil:'‡Æ≤‡Øá', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'G', trans:'Ba', tamil:'‡Æ™', chord:'Eb'},
  {note:'F', trans:'yap', tamil:'‡ÆØ‡Æ™‡Øç', chord:''},
  {note:'G', trans:'pa', tamil:'‡Æ™', chord:''},
  {note:'F', trans:'daa', tamil:'‡Æü‡Ææ', chord:''},
  {note:'Eb', trans:'thae', tamil:'‡Æ§‡Øá', chord:''},
  ],[],
  [
    {note:'F', trans:'Naa', tamil:'‡Æ®‡Ææ', chord:'Bb'},
  {note:'F', trans:'nae', tamil:'‡Æ©‡Øá', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'D', trans:'Un', tamil:'‡Æâ‡Æ©‡Øç', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'Bb', trans:'Thae', tamil:'‡Æ§‡Øá', chord:''},
  {note:'C', trans:'van', tamil:'‡Æµ‡Æ©‡Øç', chord:'Cm'}
],



/* ------------------ ‡Æ®‡Ææ‡Æ©‡Øá ‡Æâ‡Æ©‡Øç ‡Æ§‡Øá‡Æµ‡Æ©‡Øç ------------------ */


[],


/* ------------------ ‡Æµ‡Æ¥‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æö‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡ÆÆ‡ØÅ‡ÆÆ‡Øç ‡Æú‡ØÄ‡Æµ‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Ææ‡Æ©‡Øá ------------------ */
[
  {note:'C', trans:'Va', tamil:'‡Æµ', chord:'Cm'},
  {note:'C', trans:'li', tamil:'‡Æ¥‡Æø', chord:''},
  {note:'D', trans:'yum', tamil:'‡ÆØ‡ØÅ‡ÆÆ‡Øç', chord:'Gm'},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'G', trans:'Sath', tamil:'‡Æö‡Æ§‡Øç', chord:''},
  {note:'G', trans:'ya', tamil:'‡Æ§‡Æø‡ÆØ', chord:''},
  {note:'F Eb', trans:'mum', tamil:'‡ÆÆ‡ØÅ‡ÆÆ‡Øç', chord:'Eb'},
],[],
  [
    {note:'F', trans:'Jee', tamil:'‡Æú‡ØÄ', chord:''},
  {note:'F', trans:'va', tamil:'‡Æµ', chord:''},
  {note:'D C Bb', trans:'num', tamil:'‡Æ©‡ØÅ‡ÆÆ‡Øç', chord:'Bb'},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'D Bb', trans:'Naa', tamil:'‡Æ®‡Ææ', chord:''},
  {note:'C', trans:'nae', tamil:'‡Æ©‡Øá', chord:'Cm'},
      ],
[
],
[
],
[
],
[
{note:'', trans:'Saranam', tamil:'‡Æö‡Æ∞‡Æ£‡ÆÆ‡Øç', chord:''},
],
[],    // Line 5
      [
    {note:'G', trans:'Un', tamil:'‡Æâ‡Æ©‡Øç', chord:'Cm'},
  {note:'F', trans:'nai', tamil:'‡Æ©‡Øà', chord:''},
{note:'-', trans:'-', tamil:'-', chord:'-'},
      {note:'G', trans:'Naa', tamil:'‡Æ®‡Ææ', chord:''},
  {note:'Bb', trans:'nae', tamil:'‡Æ©‡Øá', chord:''},
 
     {note:'Bb', trans:'The', tamil:'‡Æ§‡ØÜ', chord:''},
  {note:'C', trans:'rin', tamil:'‡Æ∞‡Æø‡Æ®‡Øç', chord:''},
  {note:'Bb', trans:'thu', tamil:'‡Æ§‡ØÅ', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'Bb', trans:'kon', tamil:'‡Æï‡Øä‡Æ£‡Øç', chord:''},
  {note:'C', trans:'tae', tamil:'‡Æü‡Øá', chord:''},
  {note:'C', trans:'nae', tamil:'‡Æ©‡Øá', chord:''}
],

[],


/* ------------------ ‡ÆÆ‡Æï‡Æ©‡Øá ‡ÆÆ‡Æï‡Æ≥‡Øá ------------------ */
[
  {note:'Bb', trans:'Ma', tamil:'‡ÆÆ', chord:'Fm6'},
  {note:'C', trans:'ka', tamil:'‡Æï', chord:''},
  {note:'D Eb Ab', trans:'nae', tamil:'‡Æ©‡Øá', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'Bb', trans:'Ma', tamil:'‡ÆÆ', chord:'Cm'},
  {note:'C', trans:'ka', tamil:'‡Æï', chord:''},
  {note:'D Bb C', trans:'lae', tamil:'‡Æ≥‡Øá', chord:''}
],

[],


/* ------------------ ‡Æâ‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡Æø ‡Æ®‡Ææ‡Æ©‡Øç ‡ÆÖ‡Æ¥‡Øà‡Æ§‡Øç‡Æ§‡Øá‡Æ©‡Øá ------------------ */
[
   {note:'D', trans:'Un', tamil:'‡Æâ‡Æ©‡Øç', chord:'Cm'},
 {note:'-', trans:'-', tamil:'-', chord:'-'},
     {note:'D', trans:'Pey', tamil:'‡Æ™‡ØÜ', chord:''},
  {note:'D', trans:'ar', tamil:'‡ÆØ‡Æ∞‡Øç', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'D', trans:'Sol', tamil:'‡Æö‡Øä‡Æ≤‡Øç', chord:''},
  {note:'C D', trans:'li', tamil:'‡Æ≤‡Æø', chord:''},
    {note:'F', trans:'Naan', tamil:'‡Æ®‡Ææ‡Æ©‡Øç', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'Eb', trans:'A', tamil:'‡ÆÖ', chord:''},
  {note:'F', trans:'lai', tamil:'‡Æ¥‡Øà‡Æ§‡Øç', chord:''},
  {note:'D', trans:'thae', tamil:'‡Æ§‡Øá', chord:''},
  {note:'C', trans:'nae', tamil:'‡Æ©‡Øá', chord:''}
],

[],


/* ------------------ ‡Æí‡Æ∞‡ØÅ‡Æ™‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Ææ‡Æ©‡Øç ‡Æï‡Øà‡Æµ‡Æø‡Æü‡ÆÆ‡Ææ‡Æü‡Øç‡Æü‡Øá‡Æ©‡Øç ------------------ */
[
  {note:'C', trans:'O', tamil:'‡Æí', chord:'Cm'},
  {note:'C', trans:'ru', tamil:'‡Æ∞‡ØÅ', chord:''},
  {note:'C', trans:'Po', tamil:'‡Æ™‡Øã', chord:''},
  {note:'C', trans:'thum', tamil:'‡Æ§‡ØÅ‡ÆÆ‡Øç', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'G', trans:'Naan', tamil:'‡Æ®‡Ææ‡Æ©‡Øç', chord:''},
  ],[],
  [
    {note:'F', trans:'Kai', tamil:'‡Æï‡Øà', chord:'Fm'},
  {note:'F', trans:'vi', tamil:'‡Æµ‡Æø', chord:''},
  {note:'G', trans:'da', tamil:'‡Æü', chord:''},
  {note:'F', trans:'maa', tamil:'‡ÆÆ‡Ææ‡Æü‡Øç', chord:''},
  {note:'Eb', trans:'taen', tamil:'‡Æü‡Øá‡Æ©‡Øç', chord:''},
  {note:'-', trans:'-', tamil:'-', chord:'-'},
    {note:'F', trans:'Kai', tamil:'‡Æï‡Øà', chord:'Bb'},
  {note:'Eb', trans:'vi', tamil:'‡Æµ‡Æø', chord:''},
  {note:'D', trans:'da', tamil:'‡Æü', chord:''},
  {note:'Bb', trans:'maa', tamil:'‡ÆÆ‡Ææ‡Æü‡Øç', chord:''},
  {note:'C', trans:'taen', tamil:'‡Æü‡Øá‡Æ©‡Øç', chord:'Cm'},
      ],[],
	  ];

/* ------------------ TRANSPOSE HELPERS ------------------ */
const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
let currentSemis = 0;
const songEl = document.getElementById('song');

function normalizeRoot(r){
  if(!r) return r;
  const flats={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
  return flats[r] || r;
}

/* ------------------ MULTI-NOTE FIXED FUNCTIONS ------------------ */
function transposeNoteString(note, semi) {
  if (!note.trim()) return "";

  return note
    .split(" ")
    .map(n => {
      const m = n.match(/^([A-Ga-g])([#b]?)(.*)$/);
      if (!m) return n;

      let [_, root, acc, rest] = m;
      root = root.toUpperCase();
      acc = acc || "";

      const rn = normalizeRoot(root + acc);
      const i = NOTES.indexOf(rn);
      if (i < 0) return n;

      const ni = ((i + semi) % 12 + 12) % 12;
      return NOTES[ni] + rest;
    })
    .join(" ");
}

function transposeChord(ch, semi) {
  if (!ch.trim()) return "";

  return ch
    .split(" ")
    .map(c => {
      const m = c.match(/^([A-G])([#b]?)(.*)$/);
      if (!m) return c;

      let [_, root, acc, rest] = m;

      const rn = normalizeRoot(root + acc);
      const i = NOTES.indexOf(rn);
      if (i < 0) return c;

      const ni = ((i + semi) % 12 + 12) % 12;
      return NOTES[ni] + rest;
    })
    .join(" ");
}

/* ------------------ RENDER ------------------ */
function render(){
  let html = "";

  const noteActive  = toggleNotesBtn.classList.contains("active");
  const transActive = toggleTransBtn.classList.contains("active");
  const tamilActive = toggleTamilBtn.classList.contains("active");
  const chordActive = toggleChordsBtn.classList.contains("active");

  data.forEach(line=>{
    if(line.length===0){ html+="<div style='height:16px'></div>"; return; }

    html+=`<div class="song-line">`;

    line.forEach(t=>{
      const note  = noteActive  ? transposeNoteString(t.note, currentSemis) : "";
      const trans = transActive ? t.trans : "";
      const tamil = tamilActive ? t.tamil : "";
      const chord = chordActive ? transposeChord(t.chord || "", currentSemis) : "";

      html += `
        <div class="token">
           <div class="chord" style="${chordActive?'':'display:none'}">${chord}</div>
           <div class="note"  style="${noteActive?'':'display:none'}">${note}</div>
           <div class="lyric" style="${transActive?'':'display:none'}">${trans}</div>
           <div class="lyric2" style="${tamilActive?'':'display:none'}">${tamil}</div>
        </div>`;
    });

    html+=`</div>`;
  });

  songEl.innerHTML = html;
}

render();

/* ------------------ BUTTONS ------------------ */
toggleNotesBtn.onclick =()=>{toggleNotesBtn.classList.toggle("active");render();}
toggleTransBtn.onclick =()=>{toggleTransBtn.classList.toggle("active");render();}
toggleTamilBtn.onclick =()=>{toggleTamilBtn.classList.toggle("active");render();}
toggleChordsBtn.onclick =()=>{toggleChordsBtn.classList.toggle("active");render();}

up.onclick=()=>{currentSemis++;semitone.innerText=currentSemis;render();}
down.onclick=()=>{currentSemis--;semitone.innerText=currentSemis;render();}
reset.onclick=()=>{currentSemis=0;semitone.innerText=0;render();}

darkToggle.onclick=()=>{document.body.classList.toggle("dark");render();}

/* ------------------ EXPORT PNG ------------------ */
savePng.onclick=()=>{
  html2canvas(songEl).then(canvas=>{
    let link=document.createElement("a");
    link.download="song.png";
    link.href=canvas.toDataURL();
    link.click();
  });
}

/* ------------------ EXPORT PDF ------------------ */
pdfBtn.onclick = async () => {
  const { jsPDF } = window.jspdf;

  const canvas = await html2canvas(songEl, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p", "mm", "a4");
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = pdf.internal.pageSize.getHeight();

  const imgWidth = pdfWidth;
  const imgHeight = (canvas.height * pdfWidth) / canvas.width;

  let heightLeft = imgHeight;
  let position = 0;

  pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
  heightLeft -= pdfHeight;

  while (heightLeft > 0) {
    pdf.addPage();
    position = heightLeft - imgHeight;
    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pdfHeight;
  }

  pdf.save("song.pdf");
};
</script>
<script>
  fetch("/header.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("globalHeader").innerHTML = data;
    });
</script>

</body>
</html>
