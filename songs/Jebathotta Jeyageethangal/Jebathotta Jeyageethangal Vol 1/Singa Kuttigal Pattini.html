<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Singa Kuttigal</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --note-color:#ff4081;
      --chord-color:#00bcd4;
      --lyric-color:#222;
      --lyric2-color:#555;
      --bg:linear-gradient(135deg,#fbc2eb 0%,#a6c1ee 100%);
      --button-gradient:linear-gradient(135deg,#43cea2,#185a9d);
      --toggle-on:linear-gradient(135deg,#ff8a65,#ff7043);
      --toggle-off:linear-gradient(135deg,#cfd8dc,#90a4ae);
      --fz-note:15px;
      --fz-trans:16px;
      --fz-tamil:15px;
      --fz-chord:15px;
    }

    body.dark {
      --bg:#111;
      --lyric-color:#eee;
      --lyric2-color:#aaa;
      background:#111 !important;
    }

    *{box-sizing:border-box}

    body{
      font-family:'Segoe UI',Roboto,Arial,sans-serif;
      padding:24px;
      margin:0;
      background:var(--bg);
      background-attachment:fixed;
      color:var(--lyric-color);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    @media(max-width:600px){
      :root{
        --fz-note:13px;
        --fz-trans:14px;
        --fz-tamil:13px;
        --fz-chord:13px;
      }
      body{ padding:14px; }
      .controls{ width:100%; padding:14px; }
      button,.toggle-btn{ padding:8px 14px; font-size:14px; }
      .token{ min-width:28px; padding:3px 3px; min-height:68px; }
    }

    .controls{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      margin-bottom:20px;
      background:rgba(255,255,255,0.25);
      backdrop-filter:blur(6px);
      padding:18px;
      border-radius:16px;
      box-shadow:0 4px 14px rgba(0,0,0,0.2);
      width:100%;
      max-width:900px;
    }

    .checkboxes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }

    .toggle-btn{
      padding:10px 16px;
      border:none;
      border-radius:10px;
      background:var(--toggle-off);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:0.3s;
    }
    .toggle-btn.active{
      background:var(--toggle-on);
      transform:scale(1.05);
    }

    .transpose-controls,
    .size-controls{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    button{
      padding:10px 16px;
      border:none;
      border-radius:10px;
      background:var(--button-gradient);
      color:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:15px;
    }

    .value{
      min-width:40px;
      background:#fff;
      border-radius:8px;
      padding:5px 0;
      font-weight:700;
      text-align:center;
      color:#333;
    }

    #savePng{
      background:linear-gradient(135deg,#ff6f91,#ff9671);
    }

    #printBtn{
      background:linear-gradient(135deg,#9b5de5,#b983ff);
    }

    #pdfBtn{
      background:linear-gradient(135deg,#38b2ac,#4fd1c5);
    }

    /* ========== NEW EXPORT BUTTON ROW ========== */
    .export-row{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:nowrap;
      width:100%;
    }

    @media(max-width:600px){
      .export-row{
        flex-wrap:wrap;
      }
    }

    #song{
      width:100%;
      max-width:980px;
      background:rgba(255,255,255,0.7);
      padding:16px;
      border-radius:18px;
      box-shadow:0 4px 20px rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
    }

    body.dark #song {
      background:#222;
    }

    .token{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-height:72px;
      min-width:45px;
      padding:4px 6px;
      background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.3));
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      white-space:nowrap;
    }

    body.dark .token {
      background:#333;
    }

    .chord{
      min-height:18px;
      line-height:18px;
      color:var(--chord-color);
      font-weight:700;
      font-size:var(--fz-chord);
    }

    .song-line{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0;
    }

    .note{color:var(--note-color);font-weight:700;font-size:var(--fz-note);}
    .lyric{font-size:var(--fz-trans);}
    .lyric2{font-size:var(--fz-tamil);color:var(--lyric2-color);font-style:italic;}

    @media print{
      .controls,#printBtn,#savePng,#pdfBtn{display:none!important;}
      body{background:white!important;}
    }
  </style>
</head>
<body>
<div id="globalHeader"></div>
  <div class="controls">
    <button id="darkToggle">üß© Dark Mode</button>

    <div class="checkboxes">
      <button class="toggle-btn active" id="toggleNotesBtn">Notes</button>
      <button class="toggle-btn active" id="toggleTransBtn">Transliteration</button>
      <button class="toggle-btn active" id="toggleTamilBtn">Tamil</button>
      <button class="toggle-btn active" id="toggleChordsBtn">Chords</button>
    </div>

    <div class="transpose-controls">
      <button id="down">‚àí</button>
      <div class="value" id="semitone">0</div>
      <button id="up">+</button>
      <button id="reset">Reset</button>
    </div>


    <!-- NEW EXPORT BUTTON ROW -->
    <div class="export-row">
      <button id="savePng">Download as Image</button>
      <button id="printBtn" onclick="window.print()">üñ®Ô∏è Print / PDF</button>
      <button id="pdfBtn">Download PDF</button>
    </div>
  </div>

  <div id="song"></div>

<script>
/* ------------------ DATA ------------------ */
const data = [
      // Line 1
      [],[
  {note:'', trans:'Pallavi', tamil:'‡Æ™‡Æ≤‡Øç‡Æ≤‡Æµ‡Æø', chord:''},],[],
  
    [
  {note:'G',  trans:'Sin',   tamil:'‡Æö‡Æø‡Æô‡Øç', chord:'F'},
  {note:'F',  trans:'ga',    tamil:'‡Æï', chord:''},
  {note:'', trans:'-', tamil:'-', chord:''},
  {note:'G',  trans:'Kut',   tamil:'‡Æï‡ØÅ‡Æü‡Øç', chord:''},
  {note:'G',  trans:'ti',    tamil:'‡Æü‡Æø', chord:''},
  {note:'A',  trans:'gal',   tamil:'‡Æï‡Æ≥‡Øç', chord:'Am'},
],
[],[
  {note:'F',  trans:'Pat',   tamil:'‡Æ™‡Æü‡Øç', chord:'Dm'},
  {note:'F',  trans:'ti',    tamil:'‡Æü‡Æø', chord:''},
  {note:'F',  trans:'ni',    tamil:'‡Æ©‡Æø', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},
    
  {note:'G',  trans:'Ki',    tamil:'‡Æï‡Æø', chord:''},
  {note:'F',  trans:'dak',   tamil:'‡Æü‡Æï‡Øç', chord:''},
  {note:'C',  trans:'kum',   tamil:'‡Æï‡ØÅ‡ÆÆ‡Øç', chord:'C'},
],
[],
[
  {note:'C',  trans:'Aan',     tamil:'‡ÆÜ‡Æ©‡Øç', chord:'Bb'},
  {note:'D',  trans:'da',      tamil:'‡Æü', chord:''},
  {note:'D',  trans:'va',      tamil:'‡Æµ', chord:''},
  {note:'D',  trans:'rai',     tamil:'‡Æ∞‡Øà', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},
    
  {note:'D',  trans:'Thae',    tamil:'‡Æ§‡Øá', chord:'C'},
  {note:'E',  trans:'du',      tamil:'‡Æü‡ØÅ', chord:''},
  {note:'E',  trans:'vork',    tamil:'‡Æµ‡Øã‡Æ∞‡Øç‡Æï‡Øç', chord:''},

  {note:'E',  trans:'ku',      tamil:'‡Æï‡ØÅ', chord:''},],
  [],
  [
  {note:'E',  trans:'Ku',      tamil:'‡Æï‡ØÅ', chord:'F'},

  {note:'G',  trans:'rai',     tamil:'‡Æ±‡Øà', chord:''},
  {note:'G',  trans:'yil',     tamil:'‡ÆØ‡Æø‡Æ≤‡Øç', chord:''},
  {note:'G',  trans:'lai',     tamil:'‡Æ≤‡Øà', chord:''},
  {note:'F',  trans:'yae',     tamil:'‡ÆØ‡Øá', chord:''},
  
],
[],
[
  {note:'C',  trans:'Ku',      tamil:'‡Æï‡ØÅ', chord:'F'},
  {note:'Bb', trans:'rai',     tamil:'‡Æ±‡Øà', chord:''},

  {note:'Bb', trans:'yil',     tamil:'‡ÆØ‡Æø‡Æ≤‡Øç', chord:''},
  {note:'A',  trans:'lai',     tamil:'‡Æ≤‡Øà', chord:''},

  {note:'A',  trans:'yae',     tamil:'‡ÆØ‡Øá', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'C',  trans:'Ku',      tamil:'‡Æï‡ØÅ', chord:''},
  {note:'Bb', trans:'rai',     tamil:'‡Æ±‡Øà', chord:''},
  {note:'Bb', trans:'yil',     tamil:'‡ÆØ‡Æø‡Æ≤‡Øç', chord:''},

  {note:'A',  trans:'lai',     tamil:'‡Æ≤‡Øà', chord:''},
  {note:'A',  trans:'yae',     tamil:'‡ÆØ‡Øá', chord:''},
],
[],
[
  {note:'G',  trans:'Aan',     tamil:'‡ÆÜ‡Æ£‡Øç', chord:'Gm'},
  {note:'G',  trans:'da',      tamil:'‡Æü', chord:''},
  {note:'G',  trans:'va',      tamil:'‡Æµ', chord:''},
  {note:'G',  trans:'rai',     tamil:'‡Æ∞‡Øà', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'Bb', trans:'Thae',    tamil:'‡Æ§‡Øá', chord:'Bb'},
  {note:'Bb', trans:'du',      tamil:'‡Æü‡ØÅ', chord:''},
  {note:'Bb', trans:'vork',    tamil:'‡Æµ‡Øã‡Æ∞‡Øç‡Æï‡Øç', chord:''},
  {note:'Bb', trans:'ku',      tamil:'‡Æï‡ØÅ', chord:''},],[],
  [
  {note:'C',  trans:'Ku',      tamil:'‡Æï‡ØÅ', chord:'C'},

  {note:'Bb', trans:'rai',     tamil:'‡Æ±‡Øà', chord:''},
  {note:'Bb', trans:'yil',     tamil:'‡ÆØ‡Æø‡Æ≤‡Øç', chord:''},
  {note:'A',  trans:'lai',     tamil:'‡Æ≤‡Øà', chord:''},
  {note:'A',  trans:'yae',     tamil:'‡ÆØ‡Øá', chord:'F'},
],
[],[],
 [
{note:'', trans:'Saranam', tamil:'‡Æö‡Æ∞‡Æ£‡ÆÆ‡Øç', chord:''},
],[],[
  {note:'C Bb', trans:'Pul',     tamil:'‡Æ™‡ØÅ‡Æ≤‡Øç', chord:'F'},
  {note:'Bb A', trans:'lul',     tamil:'‡Æ≤‡ØÅ‡Æ≥‡Øç', chord:''},

  {note:'A',   trans:'la',      tamil:'‡Æ≥', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'C',   trans:'I',       tamil:'‡Æá', chord:'Dm'},
  {note:'Bb',  trans:'dan',     tamil:'‡Æü‡Æô‡Øç', chord:''},
  {note:'Bb',  trans:'ga',      tamil:'‡Æï', chord:''},

  {note:'A',   trans:'li',      tamil:'‡Æ≥‡Æø', chord:''},
  {note:'A',   trans:'lae',     tamil:'‡Æ≤‡Øá', chord:''},],
  [],[

  {note:'G',   trans:'Yen',     tamil:'‡Æé‡Æ©‡Øç', chord:'Gm'},
  {note:'G',   trans:'nai',     tamil:'‡Æ©‡Øà', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'G Bb', trans:'Mei',     tamil:'‡ÆÆ‡Øá‡ÆØ‡Øç‡Æï‡Øç', chord:''},
  {note:'Bb',  trans:'kin',     tamil:'‡Æï‡Æø‡Æ©‡Øç', chord:''},
  {note:'A',   trans:'draar',   tamil:'‡Æ±‡Ææ‡Æ∞‡Øç', chord:'F'},
],
[],
[
  {note:'F A',  trans:'Than',    tamil:'‡Æ§‡Æ£‡Øç', chord:'F'},
  {note:'G',   trans:'nee',     tamil:'‡Æ£‡ØÄ', chord:''},

  {note:'F',   trans:'ran',     tamil:'‡Æ∞‡Æ£‡Øç', chord:''},
  {note:'F',   trans:'dai',     tamil:'‡Æü‡Øà', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'E G',  trans:'Koo',     tamil:'‡Æï‡ØÇ‡Æü‡Øç', chord:'C6'},
  {note:'F',   trans:'ti',      tamil:'‡Æü‡Æø‡Æö‡Øç', chord:''},

  {note:'E',   trans:'Sen',     tamil:'‡Æö‡ØÜ‡Æ©‡Øç', chord:''},
  {note:'D',   trans:'dru',     tamil:'‡Æ±‡ØÅ', chord:''},],
  [],[

  {note:'D',   trans:'Thaa',    tamil:'‡Æ§‡Ææ', chord:''},
  {note:'E',   trans:'gam',     tamil:'‡Æï‡ÆÆ‡Øç', chord:''},
{note:'', trans:'-', tamil:'-', chord:''},

  {note:'G A',  trans:'Theer',   tamil:'‡Æ§‡ØÄ‡Æ∞‡Øç‡Æï‡Øç', chord:''},
  {note:'G F',  trans:'kin',     tamil:'‡Æï‡Æø‡Æ©‡Øç', chord:''},
  {note:'F',   trans:'draar',   tamil:'‡Æ±‡Ææ‡Æ∞‡Øç', chord:'F'},
],
[],
[
],
	  ];

/* ------------------ TRANSPOSE HELPERS ------------------ */
const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
let currentSemis = 0;
const songEl = document.getElementById('song');

function normalizeRoot(r){
  if(!r) return r;
  const flats={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
  return flats[r] || r;
}

/* ------------------ MULTI-NOTE FIXED FUNCTIONS ------------------ */
function transposeNoteString(note, semi) {
  if (!note.trim()) return "";

  return note
    .split(" ")
    .map(n => {
      const m = n.match(/^([A-Ga-g])([#b]?)(.*)$/);
      if (!m) return n;

      let [_, root, acc, rest] = m;
      root = root.toUpperCase();
      acc = acc || "";

      const rn = normalizeRoot(root + acc);
      const i = NOTES.indexOf(rn);
      if (i < 0) return n;

      const ni = ((i + semi) % 12 + 12) % 12;
      return NOTES[ni] + rest;
    })
    .join(" ");
}

function transposeChord(ch, semi) {
  if (!ch.trim()) return "";

  return ch
    .split(" ")
    .map(c => {
      const m = c.match(/^([A-G])([#b]?)(.*)$/);
      if (!m) return c;

      let [_, root, acc, rest] = m;

      const rn = normalizeRoot(root + acc);
      const i = NOTES.indexOf(rn);
      if (i < 0) return c;

      const ni = ((i + semi) % 12 + 12) % 12;
      return NOTES[ni] + rest;
    })
    .join(" ");
}

/* ------------------ RENDER ------------------ */
function render(){
  let html = "";

  const noteActive  = toggleNotesBtn.classList.contains("active");
  const transActive = toggleTransBtn.classList.contains("active");
  const tamilActive = toggleTamilBtn.classList.contains("active");
  const chordActive = toggleChordsBtn.classList.contains("active");

  data.forEach(line=>{
    if(line.length===0){ html+="<div style='height:16px'></div>"; return; }

    html+=`<div class="song-line">`;

    line.forEach(t=>{
      const note  = noteActive  ? transposeNoteString(t.note, currentSemis) : "";
      const trans = transActive ? t.trans : "";
      const tamil = tamilActive ? t.tamil : "";
      const chord = chordActive ? transposeChord(t.chord || "", currentSemis) : "";

      html += `
        <div class="token">
           <div class="chord" style="${chordActive?'':'display:none'}">${chord}</div>
           <div class="note"  style="${noteActive?'':'display:none'}">${note}</div>
           <div class="lyric" style="${transActive?'':'display:none'}">${trans}</div>
           <div class="lyric2" style="${tamilActive?'':'display:none'}">${tamil}</div>
        </div>`;
    });

    html+=`</div>`;
  });

  songEl.innerHTML = html;
}

render();

/* ------------------ BUTTONS ------------------ */
toggleNotesBtn.onclick =()=>{toggleNotesBtn.classList.toggle("active");render();}
toggleTransBtn.onclick =()=>{toggleTransBtn.classList.toggle("active");render();}
toggleTamilBtn.onclick =()=>{toggleTamilBtn.classList.toggle("active");render();}
toggleChordsBtn.onclick =()=>{toggleChordsBtn.classList.toggle("active");render();}

up.onclick=()=>{currentSemis++;semitone.innerText=currentSemis;render();}
down.onclick=()=>{currentSemis--;semitone.innerText=currentSemis;render();}
reset.onclick=()=>{currentSemis=0;semitone.innerText=0;render();}

darkToggle.onclick=()=>{document.body.classList.toggle("dark");render();}

/* ------------------ EXPORT PNG ------------------ */
savePng.onclick=()=>{
  html2canvas(songEl).then(canvas=>{
    let link=document.createElement("a");
    link.download="song.png";
    link.href=canvas.toDataURL();
    link.click();
  });
}

/* ------------------ EXPORT PDF ------------------ */
pdfBtn.onclick = async () => {
  const { jsPDF } = window.jspdf;

  const canvas = await html2canvas(songEl, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p", "mm", "a4");
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = pdf.internal.pageSize.getHeight();

  const imgWidth = pdfWidth;
  const imgHeight = (canvas.height * pdfWidth) / canvas.width;

  let heightLeft = imgHeight;
  let position = 0;

  pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
  heightLeft -= pdfHeight;

  while (heightLeft > 0) {
    pdf.addPage();
    position = heightLeft - imgHeight;
    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pdfHeight;
  }

  pdf.save("song.pdf");
};
</script>
<script>
  fetch("/header.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("globalHeader").innerHTML = data;
    });
</script>
</body>
</html>
